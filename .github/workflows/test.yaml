name: Test Prover and vdf_client

on:
  push:
    branches:
      - main
  release:
    types: [published]
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  test:
    name: Test ${{ matrix.config }} ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      CHIAVDF_LOG_AVX: "1"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        config: [optimized=1]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    # See: https://github.com/google/sanitizers/issues/1716
    # Fixes `FATAL: ThreadSanitizer: unexpected memory mapping 0x70498d8ae000-0x70498dd00000` type errors
    - name: Adjust mmap_rnd_bits on ubuntu
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo sysctl vm.mmap_rnd_bits=28

    - name: Build vdf-client on Ubuntu
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        # Avoid transient 404s from stale apt indices / mirror lag.
        sudo apt-get update -y -o Acquire::Retries=3
        sudo apt-get install libgmp-dev libboost-python-dev libpython3-dev libboost-system-dev build-essential -y
        cd src
        make ${{ matrix.config }} -f Makefile.vdf-client

    - name: Build vdf-client on Mac
      if: startsWith(matrix.os, 'mac')
      run: |
        brew ls --versions boost >/dev/null 2>&1 || brew install boost
        BOOST_VERSION="$(brew list --versions boost | awk '{print $2}')"
        BOOST_INCLUDE=""
        for cand in \
          "$(brew --prefix boost)/include" \
          "$(brew --prefix)/include" \
          "$(brew --cellar boost)/${BOOST_VERSION}/include"; do
          if [ -f "$cand/boost/asio.hpp" ]; then
            BOOST_INCLUDE="$cand"
            break
          fi
        done
        if [ -z "$BOOST_INCLUDE" ]; then
          echo "Could not locate boost/asio.hpp for brew boost=${BOOST_VERSION}" >&2
          brew --prefix boost || true
          brew --cellar boost || true
          brew info boost || true
          exit 1
        fi
        cd src
        make ${{ matrix.config }} CPPFLAGS="-I${BOOST_INCLUDE} ${CPPFLAGS:-}" -f Makefile.vdf-client

    - name: Cache Boost on Windows
      if: startsWith(matrix.os, 'windows')
      id: cache-boost
      uses: actions/cache/restore@v4
      with:
        path: C:\local\boost_*
        key: windows-boost-msvc-14.3-v1

    - name: Install LLVM and Ninja on Windows
      if: startsWith(matrix.os, 'windows')
      shell: pwsh
      env:
        BOOST_CACHE_HIT: ${{ steps.cache-boost.outputs.cache-hit }}
      run: |
        $llvmBin = "C:\Program Files\LLVM\bin\clang-cl.exe"
        $ninjaBin = "C:\ProgramData\chocolatey\bin\ninja.exe"
        if (-not (Test-Path $llvmBin) -or -not (Test-Path $ninjaBin)) {
          Write-Host "LLVM/Ninja not found, installing via choco"
          choco install llvm ninja -y
        } else {
          Write-Host "LLVM and Ninja already present, skipping choco install"
        }

        $boostDir = Get-ChildItem "C:\local" -Directory -Filter "boost_*" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $boostDir) {
          if ("$env:BOOST_CACHE_HIT" -ne "true") {
            Write-Host "Boost cache miss and boost not found, installing boost-msvc-14.3"
            choco install boost-msvc-14.3 -y
          } else {
            Write-Host "Boost cache reported hit but boost directory missing; reinstalling boost-msvc-14.3"
            choco install boost-msvc-14.3 -y
          }
          $boostDir = Get-ChildItem "C:\local" -Directory -Filter "boost_*" -ErrorAction SilentlyContinue | Select-Object -First 1
        } else {
          Write-Host "Boost already present at $($boostDir.FullName), skipping choco install"
        }

        "C:\Program Files\LLVM\bin" | Out-File -Append -FilePath $env:GITHUB_PATH
        "CHIA_ENABLE_AVX512_IFMA=0" | Out-File -Append -FilePath $env:GITHUB_ENV
        if (-not $boostDir) {
          throw "Boost install not found under C:\local"
        }
        "BOOST_INCLUDE_DIR=$($boostDir.FullName)" | Out-File -Append -FilePath $env:GITHUB_ENV

    - name: Save Boost cache on Windows
      if: startsWith(matrix.os, 'windows') && steps.cache-boost.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\local\boost_*
        key: ${{ steps.cache-boost.outputs.cache-primary-key }}

    - name: Cache mpir checkout on Windows
      if: startsWith(matrix.os, 'windows')
      id: cache-mpir
      uses: actions/cache@v4
      with:
        path: mpir_gc_x64
        key: windows-mpir-gc-x64-v1

    - name: Checkout mpir for Windows
      if: startsWith(matrix.os, 'windows') && steps.cache-mpir.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        repository: Chia-Network/mpir_gc_x64
        fetch-depth: 1
        path: mpir_gc_x64

    - name: Set up MSVC environment (Windows SDK + CRT libs)
      if: startsWith(matrix.os, 'windows')
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build vdf-client on Windows
      if: startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        $cmakeBuildType = "Release"
        $cmakeArgs = @(
          "-S", "src",
          "-B", "build",
          "-G", "Ninja",
          "-DCMAKE_BUILD_TYPE=$cmakeBuildType",
          "-DCMAKE_TRY_COMPILE_CONFIGURATION=Release",
          "-DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL",
          "-DCMAKE_C_COMPILER=clang-cl",
          "-DCMAKE_CXX_COMPILER=clang-cl",
          "-DCMAKE_ASM_COMPILER=clang-cl",
          "-DBOOST_INCLUDE_DIR=$env:BOOST_INCLUDE_DIR",
          "-DBUILD_PYTHON=OFF",
          "-DBUILD_CHIAVDFC=OFF",
          "-DBUILD_VDF_CLIENT=ON",
          "-DBUILD_VDF_BENCH=ON",
          "-DBUILD_VDF_TESTS=ON",
          "-DBUILD_HW_TOOLS=OFF",
          "-DENABLE_GNU_ASM=ON"
        )
        & cmake @cmakeArgs
        cmake --build build --target vdf_client vdf_bench 1weso_test 2weso_test prover_test

    - name: Run vdf tests (optimized)
      if: matrix.config == 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running 1weso_test"
        ./1weso_test
        echo "Running 2weso_test"
        ./2weso_test
        echo "Running prover_test"
        if [[ "${{ matrix.os }}" == ubuntu* ]]; then
          ./prover_test
        else
          CHIAVDF_PROVER_TEST_FAST=1 ./prover_test
        fi

    - name: Run vdf tests (short)
      if: matrix.config != 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running 1weso_test"
        ./1weso_test 1000
        echo "Running 2weso_test"
        ./2weso_test 1000

    # macos thread sanitizer will give false positives on ./prover_test because
    # it prints to std::cout from multiple threads. Which is allowed by the
    # standard
    - name: test Prover
      if: matrix.config != 'optimized=1' && (matrix.config != 'TSAN=1' || startsWith(matrix.os, 'ubuntu')) && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running prover_test"
        if [[ "${{ matrix.os }}" == ubuntu* ]]; then
          ./prover_test
        else
          CHIAVDF_PROVER_TEST_FAST=1 ./prover_test
        fi

    - name: Test vdf-client (Windows)
      if: matrix.config == 'optimized=1' && startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        Write-Host "CI commit (HEAD): $env:GITHUB_SHA"
        git rev-parse --short HEAD
        cd build
        $dllPaths = @()
        if ($env:MPIR_ROOT -and (Test-Path "$env:MPIR_ROOT\bin")) { $dllPaths += "$env:MPIR_ROOT\bin" }
        if (Test-Path "$env:GITHUB_WORKSPACE\mpir_gc_x64") { $dllPaths += "$env:GITHUB_WORKSPACE\mpir_gc_x64" }
        if ($dllPaths.Count -gt 0) { $env:PATH = ($dllPaths -join ';') + ';' + $env:PATH }
        Write-Host "PE headers (1weso_test)"
        & llvm-readobj --file-headers .\1weso_test.exe
        Write-Host "PE headers (2weso_test)"
        & llvm-readobj --file-headers .\2weso_test.exe
        Write-Host "PE headers (vdf_client)"
        & llvm-readobj --file-headers .\vdf_client.exe
        Write-Host "PE headers (vdf_bench)"
        & llvm-readobj --file-headers .\vdf_bench.exe
        Write-Host "Disasm head (asm_avx2_func_gcd_unsigned)"
        & llvm-objdump --no-show-raw-insn --disassemble-symbols=asm_avx2_func_gcd_unsigned .\1weso_test.exe
        Write-Host "Disasm head (asm_cel_func_gcd_unsigned)"
        & llvm-objdump --no-show-raw-insn --disassemble-symbols=asm_cel_func_gcd_unsigned .\1weso_test.exe
        Write-Host "Disasm around AVX2 crash RVA window"
        & llvm-objdump --no-show-raw-insn --disassemble --start-address=0x25320 --stop-address=0x254b0 .\1weso_test.exe
        Write-Host "Disasm around CEL crash RVA window"
        & llvm-objdump --no-show-raw-insn --disassemble --start-address=0x1f900 --stop-address=0x1fa90 .\1weso_test.exe
        function Invoke-BenchSmoke([string]$mode, [string]$forceCel = "") {
          if ($forceCel -ne "") {
            $env:CHIA_DEBUG_FORCE_CEL_GCD = $forceCel
          } else {
            Remove-Item Env:CHIA_DEBUG_FORCE_CEL_GCD -ErrorAction SilentlyContinue
          }
          Write-Host "Running vdf_bench square_asm smoke mode=$mode force_cel=${forceCel}"
          & .\vdf_bench.exe square_asm 10000
          $exitCode = $LASTEXITCODE
          Write-Host "vdf_bench smoke mode=$mode exit code: $exitCode"
          return $exitCode
        }
        $smokeDefault = Invoke-BenchSmoke "default"
        $smokeCel = Invoke-BenchSmoke "force_cel" "1"
        function Invoke-TestProbe([string]$name, [string[]]$testArgs = @(), [string]$forceCel = "") {
          if ($forceCel -ne "") {
            $env:CHIA_DEBUG_FORCE_CEL_GCD = $forceCel
          } else {
            Remove-Item Env:CHIA_DEBUG_FORCE_CEL_GCD -ErrorAction SilentlyContinue
          }
          Write-Host "Running probe $name force_cel=${forceCel}"
          & ".\$name.exe" @testArgs
          $exitCode = $LASTEXITCODE
          Write-Host "probe $name force_cel=${forceCel} exit code: $exitCode"
          return $exitCode
        }
        $probe1wesoDefault = Invoke-TestProbe "1weso_test" @("100") ""
        $probe1wesoCel = Invoke-TestProbe "1weso_test" @("100") "1"
        if ($smokeDefault -ne 0 -or $smokeCel -ne 0 -or $probe1wesoDefault -ne 0 -or $probe1wesoCel -ne 0) {
          exit 1
        }
        function Invoke-TestExe([string]$name, [string[]]$testArgs = @()) {
          Write-Host "Running $name"
          & ".\$name.exe" @testArgs
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Host "$name exit code: $exitCode"
            exit $exitCode
          }
          return $exitCode
        }
        Write-Host "Running 1weso_test"
        Invoke-TestExe "1weso_test" @("1000")
        Write-Host "Running 2weso_test (smoke)"
        Invoke-TestExe "2weso_test" @("100")
        Write-Host "Running 2weso_test"
        Invoke-TestExe "2weso_test" @("1000")

    - name: Benchmark vdf_bench square (Ubuntu/Mac)
      if: matrix.config == 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Benchmarking vdf_bench with 2,000,000 iterations of square_asm"
        ./vdf_bench square_asm 2000000

    - name: Benchmark vdf_bench square (Windows)
      if: matrix.config == 'optimized=1' && startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        cd build
        $dllPaths = @()
        if ($env:MPIR_ROOT -and (Test-Path "$env:MPIR_ROOT\bin")) { $dllPaths += "$env:MPIR_ROOT\bin" }
        if (Test-Path "$env:GITHUB_WORKSPACE\mpir_gc_x64") { $dllPaths += "$env:GITHUB_WORKSPACE\mpir_gc_x64" }
        if ($dllPaths.Count -gt 0) { $env:PATH = ($dllPaths -join ';') + ';' + $env:PATH }
        Write-Host "Benchmarking vdf_bench with 2,000,000 iterations of square_asm"
        & .\vdf_bench.exe square_asm 2000000
        Write-Host "vdf_bench exit code: $LASTEXITCODE"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

