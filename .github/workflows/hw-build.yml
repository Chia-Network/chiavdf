name: HW Build

on:
  push:
    branches:
      - main
    tags:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  # SHA is added to the end if on `main` to let all main workflows run
  group: ${{ github.ref }}-${{ github.workflow }}-${{ github.event_name }}-${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/long_lived/')) && github.sha || '' }}
  cancel-in-progress: true

jobs:
  build-hw:
    name: Build HW VDF Client
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgmp-dev libboost-system-dev

      - name: Download USB drivers
        run: |
          mkdir libft4222
          cd libft4222
          wget https://download.chia.net/vdf/libft4222-linux-1.4.4.170.tgz
          tar -xvzf libft4222-linux-1.4.4.170.tgz
          ln -s ${{ github.workspace }}/libft4222 ${{ github.workspace }}/src/hw/libftd2xx

      - name: Compile
        working-directory: "${{ github.workspace }}/src"
        run: make -f Makefile.vdf-client emu_hw_main hw_main emu_hw_vdf_client hw_vdf_client

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: hw-vdf
          path: |
            ${{ github.workspace }}/src/emu_hw_main
            ${{ github.workspace }}/src/hw_main
            ${{ github.workspace }}/src/hw_vdf_client
            ${{ github.workspace }}/src/emu_hw_vdf_client
            ${{ github.workspace }}/src/hw/libftd2xx/build-x86_64/libft4222.so

      - name: Get tag name
        if: startsWith(github.ref, 'refs/tags/')
        id: tag-name
        run: |
          echo "TAG_NAME=$(echo ${{ github.ref }} | cut -d'/' -f 3)" >>$GITHUB_OUTPUT

      - name: Assemble .deb
        env:
          INSTALLER_VERSION: "${{ steps.tag-name.outputs.TAG_NAME || github.sha }}"
          PLATFORM: "amd64"
        run: |
          pip install j2cli
          CLI_DEB_BASE="chiavdf-hw_$INSTALLER_VERSION-1_$PLATFORM"
          mkdir -p "dist/$CLI_DEB_BASE/usr/bin"
          mkdir -p "dist/$CLI_DEB_BASE/usr/lib"
          mkdir -p "dist/$CLI_DEB_BASE/DEBIAN"
          j2 -o "dist/$CLI_DEB_BASE/DEBIAN/control" assets/deb/control.j2

          cp ${{ github.workspace }}/src/emu_hw_main dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/hw_main dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/hw_vdf_client dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/emu_hw_vdf_client dist/$CLI_DEB_BASE/usr/bin/

          cp ${{ github.workspace }}/src/hw/libftd2xx/build-x86_64/libft4222.so dist/$CLI_DEB_BASE/usr/lib/
          dpkg-deb --build --root-owner-group "dist/$CLI_DEB_BASE"

      - name: Upload Installer
        uses: actions/upload-artifact@v3
        with:
          name: installer
          path: |
            ${{ github.workspace }}/dist/*.deb
