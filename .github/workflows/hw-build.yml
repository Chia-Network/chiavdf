name: HW Build

on:
  push:
    branches:
      - main
  release:
    types: [published]
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

concurrency:
  # SHA is added to the end if on `main` to let all main workflows run
  group: ${{ github.ref }}-${{ github.workflow }}-${{ github.event_name }}-${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/long_lived/')) && github.sha || '' }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write

jobs:
  build-hw:
    name: Build HW VDF Client (Ubuntu)
    runs-on: [ubuntu-22.04]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: Chia-Network/actions/setup-python@main
        name: Install Python
        with:
          python-version: "3.10"

      - name: Set Env
        uses: Chia-Network/actions/setjobenv@main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgmp-dev

      - name: Download USB drivers
        run: ./scripts/get-libft4222.sh install

      - name: Compile
        working-directory: "${{ github.workspace }}/src"
        run: make -f Makefile.vdf-client emu_hw_test hw_test emu_hw_vdf_client hw_vdf_client

      - name: Smoke test
        working-directory: "${{ github.workspace }}/src"
        run: |
          # CI runners do not have FT4222 hardware attached; only validate binaries exist.
          test -x ./hw_vdf_client
          test -x ./hw_test
          echo "Running emu_hw_test"
          ./emu_hw_test 1 2000
          ./emu_hw_vdf_client --list

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: hw-vdf
          path: |
            ${{ github.workspace }}/src/emu_hw_test
            ${{ github.workspace }}/src/hw_test
            ${{ github.workspace }}/src/hw_vdf_client
            ${{ github.workspace }}/src/emu_hw_vdf_client
            ${{ github.workspace }}/src/hw/libft4222/build-x86_64/libft4222.so

      - name: Assemble .deb
        env:
          INSTALLER_VERSION: "${{ env.RELEASE_TAG || format('0.0.1-{0}', github.run_id) }}"
          PLATFORM: "amd64"
        run: |
          pip install jinjanator
          CLI_DEB_BASE="chiavdf-hw_$INSTALLER_VERSION-1_$PLATFORM"
          mkdir -p "dist/$CLI_DEB_BASE/usr/bin"
          mkdir -p "dist/$CLI_DEB_BASE/usr/lib"
          mkdir -p "dist/$CLI_DEB_BASE/DEBIAN"
          mkdir -p "dist/$CLI_DEB_BASE/etc/udev/rules.d"
          j2 -o "dist/$CLI_DEB_BASE/DEBIAN/control" assets/deb/control.j2

          cp ${{ github.workspace }}/src/emu_hw_test dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/hw_test dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/hw_vdf_client dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/emu_hw_vdf_client dist/$CLI_DEB_BASE/usr/bin/
          cp ${{ github.workspace }}/src/hw/libft4222/build-x86_64/libft4222.so dist/$CLI_DEB_BASE/usr/lib/
          echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="0403", ATTRS{idProduct}=="601c", MODE="0666"' > dist/$CLI_DEB_BASE/etc/udev/rules.d/99-chiavdf.rules
          dpkg-deb --build --root-owner-group "dist/$CLI_DEB_BASE"

          echo "DEB_NAME=$CLI_DEB_BASE.deb" >> $GITHUB_ENV

      - name: Upload Installer
        uses: actions/upload-artifact@v5
        with:
          name: installer
          path: |
            ${{ github.workspace }}/dist/${{ env.DEB_NAME }}

      - name: Upload release artifacts
        if: env.RELEASE == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload \
            $RELEASE_TAG \
            dist/${{ env.DEB_NAME }}

      - uses: Chia-Network/actions/github/jwt@main
        if: env.RELEASE == 'true'

      - name: Trigger repo update
        if: env.RELEASE == 'true'
        uses: Chia-Network/actions/github/glue@main
        with:
          json_data: '{"release_version":"${{ env.RELEASE_TAG }}"}'
          glue_url: ${{ secrets.GLUE_API_URL }}
          glue_project: "chiavdf-hw"
          glue_path: "trigger"

  build-hw-macos-arm64:
    name: Build HW VDF Client (macOS arm64)
    runs-on: [macos-13-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: Chia-Network/actions/setup-python@main
        name: Install Python
        with:
          python-version: "3.10"

      - name: Set Env
        uses: Chia-Network/actions/setjobenv@main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install deps
        run: |
          brew ls --versions gmp >/dev/null 2>&1 || brew install gmp

      - name: Download USB drivers (FT4222H)
        run: ./scripts/get-libft4222.sh install

      - name: Compile
        working-directory: "${{ github.workspace }}/src"
        run: make -f Makefile.vdf-client emu_hw_test hw_test emu_hw_vdf_client hw_vdf_client

      - name: Smoke test
        working-directory: "${{ github.workspace }}/src"
        run: |
          # CI runners do not have FT4222 hardware attached; only validate binaries exist.
          test -x ./hw_vdf_client
          test -x ./hw_test
          echo "Running emu_hw_test"
          ./emu_hw_test 1 2000
          ./emu_hw_vdf_client --list

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: hw-vdf-macos-arm64
          path: |
            ${{ github.workspace }}/src/emu_hw_test
            ${{ github.workspace }}/src/hw_test
            ${{ github.workspace }}/src/hw_vdf_client
            ${{ github.workspace }}/src/emu_hw_vdf_client
            ${{ github.workspace }}/src/hw/libft4222/libft4222.dylib
            ${{ github.workspace }}/src/hw/libft4222/libft4222.1.4.4.190.dylib
            ${{ github.workspace }}/src/hw/libft4222/libftd2xx.dylib

  build-hw-windows:
    name: Build HW VDF Client (Windows)
    runs-on: [windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set Env
        uses: Chia-Network/actions/setjobenv@main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout mpir for Windows
        uses: actions/checkout@v6
        with:
          repository: Chia-Network/mpir_gc_x64
          fetch-depth: 1
          path: mpir_gc_x64

      - name: Install LLVM and Ninja on Windows
        shell: pwsh
        run: |
          $llvmBin = "C:\Program Files\LLVM\bin\clang-cl.exe"
          $ninjaBin = "C:\ProgramData\chocolatey\bin\ninja.exe"
          if (-not (Test-Path $llvmBin) -or -not (Test-Path $ninjaBin)) {
            choco install llvm ninja -y
          }
          "C:\Program Files\LLVM\bin" | Out-File -Append -FilePath $env:GITHUB_PATH

      - name: Set up MSVC environment (Windows SDK + CRT libs)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Download USB drivers (FT4222H)
        run: powershell -ExecutionPolicy Bypass -File scripts/get-libft4222.ps1 install

      - name: Configure hw tools
        shell: pwsh
        run: |
          cmake -S src -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TRY_COMPILE_CONFIGURATION=Release -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL -DCMAKE_C_COMPILER=clang-cl -DCMAKE_CXX_COMPILER=clang-cl -DCMAKE_ASM_COMPILER=clang-cl -DBUILD_PYTHON=OFF -DBUILD_CHIAVDFC=OFF -DBUILD_HW_TOOLS=ON

      - name: Build hw tools
        shell: pwsh
        run: |
          cmake --build build --target emu_hw_test
          cmake --build build --target hw_test

      - name: Smoke test
        working-directory: "${{ github.workspace }}/build"
        shell: pwsh
        run: |
          # Keep native stderr as log output; emu binaries log diagnostics there.
          $PSNativeCommandUseErrorActionPreference = $false
          $dllPaths = @()
          if (Test-Path "$env:GITHUB_WORKSPACE\mpir_gc_x64") { $dllPaths += "$env:GITHUB_WORKSPACE\mpir_gc_x64" }
          if (Test-Path "$env:GITHUB_WORKSPACE\src\hw\libft4222") { $dllPaths += "$env:GITHUB_WORKSPACE\src\hw\libft4222" }
          if ($dllPaths.Count -gt 0) { $env:PATH = ($dllPaths -join ';') + ';' + $env:PATH }
          if (Test-Path ".\hw_test.exe") { Write-Host "hw_test.exe present" }
          Write-Host "Running emu_hw_test"
          .\emu_hw_test.exe 1 2000
          if ($LASTEXITCODE -ne 0) { throw "emu_hw_test failed with exit code $LASTEXITCODE" }
          Write-Host "emu_hw_test completed"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: hw-vdf-windows
          path: |
            ${{ github.workspace }}/build/emu_hw_test.exe
            ${{ github.workspace }}/build/hw_test.exe
            ${{ github.workspace }}/src/hw/libft4222/libft4222.dll
            ${{ github.workspace }}/src/hw/libft4222/ftd2xx.dll
            ${{ github.workspace }}/src/hw/libft4222/libft4222.lib
            ${{ github.workspace }}/src/hw/libft4222/ftd2xx.lib
