name: Test Prover and vdf_client

on:
  push:
    branches:
      - main
  release:
    types: [published]
  pull_request:
    branches:
      - '**'

jobs:
  test:
    name: Test ${{ matrix.config }} ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      CHIAVDF_LOG_AVX: "1"
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13-intel
            config: optimized=1
          - os: macos-13-arm64
            config: optimized=1
          - os: ubuntu-latest
            config: optimized=1
          - os: windows-latest
            config: optimized=1

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    # See: https://github.com/google/sanitizers/issues/1716
    # Fixes `FATAL: ThreadSanitizer: unexpected memory mapping 0x70498d8ae000-0x70498dd00000` type errors
    - name: Adjust mmap_rnd_bits on ubuntu
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo sysctl vm.mmap_rnd_bits=28

    - name: Build vdf-client on Ubuntu
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        # Avoid transient 404s from stale apt indices / mirror lag.
        sudo apt-get update -y -o Acquire::Retries=3
        sudo apt-get install libgmp-dev libboost-python-dev libpython3-dev libboost-system-dev build-essential -y
        cd src
        make ${{ matrix.config }} -f Makefile.vdf-client

    - name: Build vdf-client on Mac
      if: startsWith(matrix.os, 'mac')
      run: |
        brew ls --versions boost >/dev/null 2>&1 || brew install boost
        BOOST_VERSION="$(brew list --versions boost | awk '{print $2}')"
        BOOST_INCLUDE=""
        for cand in \
          "$(brew --prefix boost)/include" \
          "$(brew --prefix)/include" \
          "$(brew --cellar boost)/${BOOST_VERSION}/include"; do
          if [ -f "$cand/boost/asio.hpp" ]; then
            BOOST_INCLUDE="$cand"
            break
          fi
        done
        if [ -z "$BOOST_INCLUDE" ]; then
          echo "Could not locate boost/asio.hpp for brew boost=${BOOST_VERSION}" >&2
          brew --prefix boost || true
          brew --cellar boost || true
          brew info boost || true
          exit 1
        fi
        cd src
        make ${{ matrix.config }} CPPFLAGS="-I${BOOST_INCLUDE} ${CPPFLAGS:-}" -f Makefile.vdf-client

    - name: Cache Boost on Windows
      if: startsWith(matrix.os, 'windows')
      id: cache-boost
      uses: actions/cache/restore@v4
      with:
        path: C:\local\boost_*
        key: windows-boost-msvc-14.3-v1

    - name: Install LLVM and Ninja on Windows
      if: startsWith(matrix.os, 'windows')
      shell: pwsh
      env:
        BOOST_CACHE_HIT: ${{ steps.cache-boost.outputs.cache-hit }}
      run: |
        $llvmBin = "C:\Program Files\LLVM\bin\clang-cl.exe"
        $ninjaBin = "C:\ProgramData\chocolatey\bin\ninja.exe"
        if (-not (Test-Path $llvmBin) -or -not (Test-Path $ninjaBin)) {
          Write-Host "LLVM/Ninja not found, installing via choco"
          choco install llvm ninja -y
        } else {
          Write-Host "LLVM and Ninja already present, skipping choco install"
        }

        $boostDir = Get-ChildItem "C:\local" -Directory -Filter "boost_*" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $boostDir) {
          if ("$env:BOOST_CACHE_HIT" -ne "true") {
            Write-Host "Boost cache miss and boost not found, installing boost-msvc-14.3"
            choco install boost-msvc-14.3 -y
          } else {
            Write-Host "Boost cache reported hit but boost directory missing; reinstalling boost-msvc-14.3"
            choco install boost-msvc-14.3 -y
          }
          $boostDir = Get-ChildItem "C:\local" -Directory -Filter "boost_*" -ErrorAction SilentlyContinue | Select-Object -First 1
        } else {
          Write-Host "Boost already present at $($boostDir.FullName), skipping choco install"
        }

        "C:\Program Files\LLVM\bin" | Out-File -Append -FilePath $env:GITHUB_PATH
        # Enable AVX-512 IFMA codegen in CI; runtime dispatch remains CPUID-gated.
        "CHIA_ENABLE_AVX512_IFMA=1" | Out-File -Append -FilePath $env:GITHUB_ENV
        if (-not $boostDir) {
          throw "Boost install not found under C:\local"
        }
        "BOOST_INCLUDE_DIR=$($boostDir.FullName)" | Out-File -Append -FilePath $env:GITHUB_ENV

    - name: Save Boost cache on Windows
      if: startsWith(matrix.os, 'windows') && steps.cache-boost.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: C:\local\boost_*
        key: ${{ steps.cache-boost.outputs.cache-primary-key }}

    - name: Cache mpir checkout on Windows
      if: startsWith(matrix.os, 'windows')
      id: cache-mpir
      uses: actions/cache@v4
      with:
        path: mpir_gc_x64
        key: windows-mpir-gc-x64-v1

    - name: Checkout mpir for Windows
      if: startsWith(matrix.os, 'windows') && steps.cache-mpir.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        repository: Chia-Network/mpir_gc_x64
        fetch-depth: 1
        path: mpir_gc_x64

    - name: Set up MSVC environment (Windows SDK + CRT libs)
      if: startsWith(matrix.os, 'windows')
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build vdf-client on Windows
      if: startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        $cmakeBuildType = "Release"
        $cmakeArgs = @(
          "-S", "src",
          "-B", "build",
          "-G", "Ninja",
          "-DCMAKE_BUILD_TYPE=$cmakeBuildType",
          "-DCMAKE_TRY_COMPILE_CONFIGURATION=Release",
          "-DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL",
          "-DCMAKE_C_COMPILER=clang-cl",
          "-DCMAKE_CXX_COMPILER=clang-cl",
          "-DCMAKE_ASM_COMPILER=clang-cl",
          "-DBOOST_INCLUDE_DIR=$env:BOOST_INCLUDE_DIR",
          "-DBUILD_PYTHON=OFF",
          "-DBUILD_CHIAVDFC=OFF",
          "-DBUILD_VDF_CLIENT=ON",
          "-DBUILD_VDF_BENCH=ON",
          "-DBUILD_VDF_TESTS=ON",
          "-DBUILD_HW_TOOLS=OFF",
          "-DENABLE_GNU_ASM=ON"
        )
        & cmake @cmakeArgs
        $gnuAsmEnabled = (& cmake -N -L build | Select-String '^ENABLE_GNU_ASM:BOOL=ON$')
        if (-not $gnuAsmEnabled) {
          throw "ENABLE_GNU_ASM is not ON on Windows CI build"
        }
        cmake --build build --target vdf_client vdf_bench 1weso_test 2weso_test prover_test
        $asmFiles = @(
          "build/asm_compiled.s",
          "build/avx2_asm_compiled.s",
          "build/avx512_asm_compiled.s"
        )
        foreach ($asmFile in $asmFiles) {
          if (-not (Test-Path $asmFile)) {
            throw "Expected generated asm output not found: $asmFile"
          }
        }

    - name: Run vdf tests (optimized)
      if: matrix.config == 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running 1weso_test"
        ./1weso_test
        # PERF_INVESTIGATION_TEMP: keep non-target tests at smoke level for faster perf investigation turnaround.
        echo "Running 2weso_test with 10 iterations (smoke)"
        ./2weso_test 10
        echo "Running prover_test"
        CHIAVDF_PROVER_TEST_FAST=1 ./prover_test

    - name: Run vdf tests (short)
      if: matrix.config != 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running 1weso_test"
        ./1weso_test 1000
        echo "Running 2weso_test"
        ./2weso_test 1000

    # macos thread sanitizer will give false positives on ./prover_test because
    # it prints to std::cout from multiple threads. Which is allowed by the
    # standard
    - name: test Prover
      if: matrix.config != 'optimized=1' && (matrix.config != 'TSAN=1' || startsWith(matrix.os, 'ubuntu')) && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        echo "Running prover_test"
        if [[ "${{ matrix.os }}" == ubuntu* ]]; then
          ./prover_test
        else
          CHIAVDF_PROVER_TEST_FAST=1 ./prover_test
        fi

    - name: Test vdf-client (Windows)
      if: matrix.config == 'optimized=1' && startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        cd build
        $dllPaths = @()
        if ($env:MPIR_ROOT -and (Test-Path "$env:MPIR_ROOT\bin")) { $dllPaths += "$env:MPIR_ROOT\bin" }
        if (Test-Path "$env:GITHUB_WORKSPACE\mpir_gc_x64") { $dllPaths += "$env:GITHUB_WORKSPACE\mpir_gc_x64" }
        if ($dllPaths.Count -gt 0) { $env:PATH = ($dllPaths -join ';') + ';' + $env:PATH }
        function Invoke-TestExe([string]$name, [string[]]$testArgs = @()) {
          Write-Host "Running $name"
          & ".\$name.exe" @testArgs
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Host "$name exit code: $exitCode"
            exit $exitCode
          }
          return $exitCode
        }
        Write-Host "Running 1weso_test"
        Invoke-TestExe "1weso_test"
        # PERF_INVESTIGATION_TEMP: keep non-target tests at smoke level for faster perf investigation turnaround.
        Write-Host "Running 2weso_test with 10 iterations (smoke)"
        Invoke-TestExe "2weso_test" @("10")
        Write-Host "Running prover_test"
        $env:CHIAVDF_PROVER_TEST_FAST = "1"
        Invoke-TestExe "prover_test"

    - name: Benchmark vdf_bench square (Ubuntu/Mac)
      if: matrix.config == 'optimized=1' && !startsWith(matrix.os, 'windows')
      run: |
        cd src
        # PERF_INVESTIGATION_TEMP: lower non-target benchmark load to speed overall CI turnaround.
        echo "Benchmarking vdf_bench with 250,000 iterations of square_asm"
        CHIAVDF_PERF_TRACE=1 ./vdf_bench square_asm 250000

    - name: Benchmark vdf_bench square (Windows, perf investigation)
      if: matrix.config == 'optimized=1' && startsWith(matrix.os, 'windows')
      shell: pwsh
      run: |
        # PERF_INVESTIGATION_TEMP: repeated benchmark harness for Windows regression isolation.
        cd build
        $dllPaths = @()
        if ($env:MPIR_ROOT -and (Test-Path "$env:MPIR_ROOT\bin")) { $dllPaths += "$env:MPIR_ROOT\bin" }
        if (Test-Path "$env:GITHUB_WORKSPACE\mpir_gc_x64") { $dllPaths += "$env:GITHUB_WORKSPACE\mpir_gc_x64" }
        if ($dllPaths.Count -gt 0) { $env:PATH = ($dllPaths -join ';') + ';' + $env:PATH }
        $env:CHIAVDF_PERF_TRACE = "1"

        Write-Host "PERF_INVESTIGATION_TEMP warmup: square_asm 10000"
        & .\vdf_bench.exe square_asm 10000
        if ($LASTEXITCODE -ne 0) {
          Write-Host "warmup exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        }

        $repetitions = 5
        $iterations = 1000000
        $ipsValues = @()
        $metricLines = @()
        $metricsPath = Join-Path $env:RUNNER_TEMP "PERF_INVESTIGATION_TEMP_windows_metrics.txt"
        "PERF_INVESTIGATION_TEMP begin" | Out-File -FilePath $metricsPath -Encoding utf8
        for ($i = 1; $i -le $repetitions; $i++) {
          Write-Host "PERF_INVESTIGATION_TEMP run $i/${repetitions}: square_asm $iterations"
          $runOutput = & .\vdf_bench.exe square_asm $iterations 2>&1
          $exitCode = $LASTEXITCODE
          $runOutput | ForEach-Object { Write-Host $_ }
          if ($exitCode -ne 0) {
            Write-Host "vdf_bench run $i exit code: $exitCode"
            exit $exitCode
          }
          $metricLine = $runOutput | Select-String -Pattern 'PERF_INVESTIGATION_TEMP mode=square_asm .*ips=([0-9]+(?:\.[0-9]+)?)' | Select-Object -Last 1
          if (-not $metricLine) {
            throw "Missing PERF_INVESTIGATION_TEMP metric line in run $i output"
          }
          $metricText = $metricLine.ToString()
          $metricLines += $metricText
          $metricText | Out-File -FilePath $metricsPath -Encoding utf8 -Append
          $ips = [double]$metricLine.Matches[0].Groups[1].Value
          $ipsValues += $ips
        }

        $avg = ($ipsValues | Measure-Object -Average).Average
        $min = ($ipsValues | Measure-Object -Minimum).Minimum
        $max = ($ipsValues | Measure-Object -Maximum).Maximum
        $variance = 0.0
        foreach ($v in $ipsValues) {
          $delta = $v - $avg
          $variance += $delta * $delta
        }
        $stddev = [Math]::Sqrt($variance / $ipsValues.Count)
        $joinedIps = ($ipsValues | ForEach-Object { "{0:N3}" -f $_ }) -join ", "

        Write-Host ("PERF_INVESTIGATION_TEMP summary runs={0} iterations={1} ips_values=[{2}] avg={3:N3} stddev={4:N3} min={5:N3} max={6:N3}" -f $repetitions, $iterations, $joinedIps, $avg, $stddev, $min, $max)
        ("PERF_INVESTIGATION_TEMP summary runs={0} iterations={1} ips_values=[{2}] avg={3:N3} stddev={4:N3} min={5:N3} max={6:N3}" -f $repetitions, $iterations, $joinedIps, $avg, $stddev, $min, $max) | Out-File -FilePath $metricsPath -Encoding utf8 -Append
        "## PERF_INVESTIGATION_TEMP Windows square_asm`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- runs: {0}" -f $repetitions) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- iterations_per_run: {0}" -f $iterations) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- ips_values: {0}" -f $joinedIps) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- avg_ips: {0:N3}" -f $avg) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- stddev_ips: {0:N3}" -f $stddev) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- min_ips: {0:N3}" -f $min) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
        ("- max_ips: {0:N3}" -f $max) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

    - name: Upload Windows perf investigation metrics
      if: matrix.config == 'optimized=1' && startsWith(matrix.os, 'windows')
      uses: actions/upload-artifact@v4
      with:
        name: PERF_INVESTIGATION_TEMP-windows-square-asm-metrics
        path: ${{ runner.temp }}/PERF_INVESTIGATION_TEMP_windows_metrics.txt
        if-no-files-found: error

